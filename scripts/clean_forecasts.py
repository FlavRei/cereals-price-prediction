import pandas as pd
import os

def format_prophet_forecast(forecast_csv, output_csv, last_historical_year=2023):
    """
    Reads a CSV generated by Prophet (with all columns),
    only keeps the future part (after the last historical year),
    and rename/simplify the columns.
    """

    df = pd.read_csv(forecast_csv, parse_dates=['ds'])
    df = df[df['ds'].dt.year > last_historical_year]
    df = df[['ds', 'yhat', 'yhat_lower', 'yhat_upper']]

    df.rename(columns={
        'ds': 'date',
        'yhat': 'Predicted Value',
        'yhat_lower': 'Predicted Value Lower',
        'yhat_upper': 'Predicted Value Upper'
    }, inplace=True)

    df['Year'] = df['date'].dt.year
    df = df[['Year', 'Predicted Value', 'Predicted Value Lower', 'Predicted Value Upper']]

    df['Predicted Value'] = df['Predicted Value'].round(2)
    df['Predicted Value Lower'] = df['Predicted Value Lower'].round(2)
    df['Predicted Value Upper'] = df['Predicted Value Upper'].round(2)

    df.to_csv(output_csv, index=False)
    print(f"Final forecast file: {output_csv}")


if __name__ == "__main__":
    os.makedirs("data/clean", exist_ok=True)

    format_prophet_forecast("data/forecast/wheat_france_forecast.csv", "data/clean/wheat_france_forecast_clean.csv")
    format_prophet_forecast("data/forecast/oats_france_forecast.csv", "data/clean/oats_france_forecast_clean.csv")
    format_prophet_forecast("data/forecast/rapeseed_france_forecast.csv", "data/clean/rapeseed_france_forecast_clean.csv")
    format_prophet_forecast("data/forecast/sunflower_france_forecast.csv", "data/clean/sunflower_france_forecast_clean.csv")
    format_prophet_forecast("data/forecast/corn_france_forecast.csv", "data/clean/corn_france_forecast_clean.csv")
