import pandas as pd
import os

def format_prophet_forecast(forecast_csv, output_csv, last_historical_year=2023):
    """
    Reads a CSV generated by Prophet (with all columns),
    only keeps the future part (after the last historical year),
    and rename/simplify the columns.
    """

    df = pd.read_csv(forecast_csv, parse_dates=['ds'])
    df = df[df['ds'].dt.year > last_historical_year]
    df = df[['ds', 'yhat', 'yhat_lower', 'yhat_upper']]

    df.rename(columns={
        'ds': 'date',
        'yhat': 'predicted_price_usd_tonne',
        'yhat_lower': 'predicted_price_lower',
        'yhat_upper': 'predicted_price_upper'
    }, inplace=True)

    df['year'] = df['date'].dt.year
    df = df[['year', 'predicted_price_usd_tonne', 'predicted_price_lower', 'predicted_price_upper']]

    df['predicted_price_usd_tonne'] = df['predicted_price_usd_tonne'].round(2)
    df['predicted_price_lower'] = df['predicted_price_lower'].round(2)
    df['predicted_price_upper'] = df['predicted_price_upper'].round(2)

    df.to_csv(output_csv, index=False)
    print(f"Final forecast file: {output_csv}")


if __name__ == "__main__":
    os.makedirs("data/clean", exist_ok=True)

    format_prophet_forecast("data/forecast/wheat_france_forecast.csv", "data/clean/wheat_france_forecast_clean.csv")
    format_prophet_forecast("data/forecast/oats_france_forecast.csv", "data/clean/oats_france_forecast_clean.csv")
    format_prophet_forecast("data/forecast/rapeseed_france_forecast.csv", "data/clean/rapeseed_france_forecast_clean.csv")
    format_prophet_forecast("data/forecast/sunflower_france_forecast.csv", "data/clean/sunflower_france_forecast_clean.csv")
    format_prophet_forecast("data/forecast/corn_france_forecast.csv", "data/clean/corn_france_forecast_clean.csv")
